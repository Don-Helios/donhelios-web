<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <meta name="referrer" content="origin">
</head>
<body>
  <!-- Debug panel -->
  <div id="debug-info" style="position: fixed; top: 10px; right: 10px; background: #f0f0f0; padding: 10px; font-size: 12px; border: 1px solid #ccc; z-index: 9999; max-width: 300px;">
    <div>Loading Decap CMS...</div>
    <div id="storage-test"></div>
    <div id="https-test"></div>
    <div id="cms-status"></div>
    <div id="message-debug" style="margin-top: 10px; font-family: monospace; font-size: 10px;"></div>
  </div>

  <script>
    // Test storage availability
    function testStorage() {
      const debugEl = document.getElementById('storage-test');
      try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        debugEl.innerHTML += '<div style="color: green;">‚úì localStorage available</div>';
        return true;
      } catch (e) {
        debugEl.innerHTML += '<div style="color: red;">‚úó localStorage blocked: ' + e.message + '</div>';
        return false;
      }
    }

    // Test HTTPS
    function testHTTPS() {
      const debugEl = document.getElementById('https-test');
      if (location.protocol === 'https:') {
        debugEl.innerHTML += '<div style="color: green;">‚úì HTTPS enabled</div>';
        return true;
      } else {
        debugEl.innerHTML += '<div style="color: red;">‚úó HTTP detected (HTTPS required)</div>';
        return false;
      }
    }

    // Run tests
    const storageOK = testStorage();
    const httpsOK = testHTTPS();
    
    if (!httpsOK) {
      document.body.innerHTML = '<div style="padding: 20px; background: #ffebee; border: 1px solid #f44336; margin: 20px;"><h2>HTTPS Required</h2><p>Decap CMS requires HTTPS to function properly. Please access this page via <strong>https://</strong> instead of http://</p><p>Try: <a href="https://donhelios.com/admin/">https://donhelios.com/admin/</a></p></div>';
    } else if (!storageOK) {
      document.body.innerHTML = '<div style="padding: 20px; background: #fff3e0; border: 1px solid #ff9800; margin: 20px;"><h2>Browser Storage Blocked</h2><p>Your browser is blocking localStorage access. This can happen in:</p><ul><li>Private/Incognito mode</li><li>Some browser security settings</li><li>Certain extensions</li></ul><p>Please try:</p><ul><li>Regular browser window (not incognito)</li><li>Different browser</li><li>Check browser privacy settings</li></ul></div>';
    } else {
      // Add message debugging BEFORE loading CMS
      window.addEventListener('message', function(event) {
        const debugEl = document.getElementById('message-debug');
        console.log('Raw postMessage received:', event);
        console.log('Event origin:', event.origin);
        console.log('Event data:', event.data);
        
        debugEl.innerHTML += `<div style="color: blue;">Message from: ${event.origin}</div>`;
        debugEl.innerHTML += `<div style="color: blue;">Data: ${JSON.stringify(event.data)}</div>`;
        
        if (event.data && typeof event.data === 'string' && event.data.includes('authorization:github:success')) {
          console.log('GitHub auth success message detected!');
          debugEl.innerHTML += '<div style="color: orange;">üî• Auth success detected!</div>';
          
          // Extract and manually store the token
          try {
            const tokenMatch = event.data.match(/authorization:github:success:(.+)/);
            if (tokenMatch) {
              const authData = JSON.parse(tokenMatch[1]);
              console.log('Parsed auth data:', authData);
              
              // Wait longer for CMS to process the message naturally
              debugEl.innerHTML += '<div style="color: yellow;">‚è≥ Waiting for CMS to process...</div>';
              
              // Check multiple localStorage formats that CMS might use
              setTimeout(() => {
                console.log('=== CHECKING ALL POSSIBLE CMS KEYS ===');
                Object.keys(localStorage).forEach(key => {
                  console.log(`${key}:`, localStorage.getItem(key));
                });
                
                // Try different key formats if nothing is stored
                const possibleKeys = [
                  'decap-cms.user',
                  'netlify-cms.user', 
                  'decap-cms.auth',
                  'netlify-cms.auth',
                  'decap-cms-user',
                  'cms-user'
                ];
                
                let tokenStored = false;
                possibleKeys.forEach(key => {
                  if (localStorage.getItem(key)) {
                    tokenStored = true;
                  }
                });
                
                if (!tokenStored) {
                  console.log('No token found, trying manual storage...');
                  // Try the most likely format
                  const userData = {
                    token: authData.token,
                    provider: 'github',
                    backendName: 'github'
                  };
                  localStorage.setItem('decap-cms.user', JSON.stringify(userData));
                  debugEl.innerHTML += '<div style="color: green;">‚úì Token manually stored</div>';
                  
                  setTimeout(() => {
                    debugEl.innerHTML += '<div style="color: blue;">üîÑ Reloading...</div>';
                    window.location.reload();
                  }, 1000);
                } else {
                  debugEl.innerHTML += '<div style="color: green;">‚úì Token found in storage!</div>';
                }
              }, 3000);
            }
          } catch (e) {
            console.error('Failed to parse auth data:', e);
            debugEl.innerHTML += '<div style="color: red;">‚úó Failed to parse token</div>';
          }
          
          // Check localStorage after the message
          setTimeout(() => {
            console.log('localStorage after auth message:', Object.keys(localStorage));
            Object.keys(localStorage).forEach(key => {
              if (key.toLowerCase().includes('cms') || key.toLowerCase().includes('auth') || key.toLowerCase().includes('token')) {
                console.log(`${key}:`, localStorage.getItem(key));
              }
            });
            
            debugEl.innerHTML += '<div style="color: purple;">Checked localStorage (see console)</div>';
          }, 1000);
        }
      });

      // Storage works, load CMS
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/decap-cms@^3.7.1/dist/decap-cms.js';
      script.onload = function() {
        document.getElementById('cms-status').innerHTML = '<div style="color: green;">‚úì Decap CMS loaded</div>';
        
        // Hide debug panel after 10 seconds (extended for debugging)
        setTimeout(() => {
          const debugPanel = document.getElementById('debug-info');
          if (debugPanel) {
            debugPanel.style.opacity = '0.3';
          }
        }, 10000);
      };
      script.onerror = function() {
        document.getElementById('cms-status').innerHTML = '<div style="color: red;">‚úó Failed to load Decap CMS</div>';
      };
      document.head.appendChild(script);
    }
  </script>
</body>
</html>
